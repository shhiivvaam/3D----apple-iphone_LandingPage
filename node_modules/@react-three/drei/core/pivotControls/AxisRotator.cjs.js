"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("three"),r=require("@react-three/fiber"),n=require("../Line.cjs.js"),o=require("../../web/Html.cjs.js"),a=require("lodash.clamp"),i=require("./context.cjs.js");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("@babel/runtime/helpers/extends"),require("three-stdlib"),require("react-dom/client");var s=c(e),u=c(t),d=l(a);const p=new u.Vector3,m=new u.Vector3,f=e=>180*e/Math.PI,h=e=>{let t=((e,t)=>{let r=Math.floor(e/t);return r=r<0?r+1:r,e-r*t})(e,2*Math.PI);return Math.abs(t)<1e-6?0:(t<0&&(t+=2*Math.PI),t)},x=new u.Matrix4,P=new u.Vector3,b=new u.Ray,M=new u.Vector3;exports.AxisRotator=({dir1:e,dir2:t,axis:a})=>{const{rotationLimits:l,annotationsClass:c,depthTest:y,scale:g,lineWidth:w,fixed:v,axisColors:C,hoveredColor:j,opacity:k,onDragStart:q,onDrag:O,onDragEnd:I,userData:R}=s.useContext(i.context),V=r.useThree((e=>e.controls)),F=s.useRef(null),D=s.useRef(null),E=s.useRef(0),W=s.useRef(0),z=s.useRef(null),[T,A]=s.useState(!1),L=s.useCallback((e=>{F.current.innerText=`${f(W.current).toFixed(0)}ยบ`,F.current.style.display="block",e.stopPropagation();const t=e.point.clone(),r=(new u.Vector3).setFromMatrixPosition(D.current.matrixWorld),n=(new u.Vector3).setFromMatrixColumn(D.current.matrixWorld,0).normalize(),o=(new u.Vector3).setFromMatrixColumn(D.current.matrixWorld,1).normalize(),a=(new u.Vector3).setFromMatrixColumn(D.current.matrixWorld,2).normalize(),i=(new u.Plane).setFromNormalAndCoplanarPoint(a,r);z.current={clickPoint:t,origin:r,e1:n,e2:o,normal:a,plane:i},q(),V&&(V.enabled=!1),e.target.setPointerCapture(e.pointerId)}),[V,q]),_=s.useCallback((e=>{if(e.stopPropagation(),T||A(!0),z.current){const{clickPoint:t,origin:r,e1:n,e2:o,normal:i,plane:c}=z.current,[s,u]=(null==l?void 0:l[a])||[void 0,void 0];b.copy(e.ray),b.intersectPlane(c,M),b.direction.negate(),b.intersectPlane(c,M);let y=((e,t,r,n,o)=>{p.copy(e).sub(r),m.copy(t).sub(r);const a=n.dot(n),i=o.dot(o),l=p.dot(n)/a,c=p.dot(o)/i,s=m.dot(n)/a,u=m.dot(o)/i,d=Math.atan2(c,l);return Math.atan2(u,s)-d})(t,M,r,n,o),g=f(y);e.shiftKey&&(g=10*Math.round(g/10),y=(e=>e*Math.PI/180)(g)),void 0!==s&&void 0!==u&&(y=h(y),y=y>Math.PI?y-2*Math.PI:y,y=d.default(y,s-E.current,u-E.current),W.current=E.current+y,g=f(W.current)),F.current.innerText=`${g.toFixed(0)} ยบ`,x.makeRotationAxis(i,y),P.copy(r).applyMatrix4(x).sub(r).negate(),x.setPosition(P),O(x)}}),[O,T,l,a]),S=s.useCallback((e=>{F.current.style.display="none",e.stopPropagation(),E.current=W.current,z.current=null,I(),V&&(V.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[V,I]),H=s.useCallback((e=>{e.stopPropagation(),A(!1)}),[]),N=s.useMemo((()=>{const r=e.clone().normalize(),n=t.clone().normalize();return(new u.Matrix4).makeBasis(r,n,r.clone().cross(n))}),[e,t]),U=v?.65:.65*g,$=s.useMemo((()=>{const e=[];for(let t=0;t<=32;t++){const r=t*(Math.PI/2)/32;e.push(new u.Vector3(Math.cos(r)*U,Math.sin(r)*U,0))}return e}),[U]);return s.createElement("group",{ref:D,onPointerDown:L,onPointerMove:_,onPointerUp:S,onPointerOut:H,matrix:N,matrixAutoUpdate:!1},s.createElement(o.Html,{position:[U,U,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:c,ref:F})),s.createElement(n.Line,{points:$,lineWidth:4*w,visible:!1,userData:R}),s.createElement(n.Line,{transparent:!0,raycast:()=>null,depthTest:y,points:$,lineWidth:w,color:T?j:C[a],opacity:k,polygonOffset:!0,polygonOffsetFactor:-10}))};
